---
name: Android CI (Zeta · Self-Healing · Meta-Verifier · Cloud APK/AAB)

+on:
  workflow_dispatch:
    inputs: {}
  push:
    branches:
      - main

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      GRADLE_VERSION: "8.5"
      AGP_VERSION: "8.2.2"
      KOTLIN_VERSION: "1.9.22"

    steps:
      # ============================================================
      # t00 — CHECKOUT
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # t01 — JDK 17
      # ============================================================
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ============================================================
      # t02 — ANDROID SDK
      # ============================================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================================
      # t03 — HOST GRADLE (BOOTSTRAP ONLY)
      # ============================================================
      - name: Setup Host Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      # ============================================================
      # t04 — SELF-HEAL PROJECT STRUCTURE
      # ============================================================
      - name: Self-heal Android project
        shell: bash
        run: |
          set -euo pipefail

          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          cat > local.properties <<EOF
          sdk.dir=${ANDROID_HOME}
          EOF

          cat > settings.gradle <<'EOF'
          pluginManagement {
            repositories {
              google()
              mavenCentral()
              gradlePluginPortal()
            }
          }
          dependencyResolutionManagement {
            repositoriesMode.set(
              RepositoriesMode.FAIL_ON_PROJECT_REPOS
            )
            repositories {
              google()
              mavenCentral()
            }
          }
          rootProject.name = "Bestapp"
          include(":app")
          EOF

          cat > build.gradle <<EOF
          plugins {
            id "com.android.application" version \
              "${AGP_VERSION}" apply false
            id "org.jetbrains.kotlin.android" version \
              "${KOTLIN_VERSION}" apply false
          }
          EOF

          mkdir -p app/src/main

          cat > app/build.gradle <<'EOF'
          plugins {
            id "com.android.application"
            id "org.jetbrains.kotlin.android"
          }

          android {
            namespace "com.example.bestapp"
            compileSdk 34

            defaultConfig {
              applicationId "com.example.bestapp"
              minSdk 21
              targetSdk 34
              versionCode 1
              versionName "1.0"
            }

            buildTypes {
              release {
                minifyEnabled false
              }
            }

            compileOptions {
              sourceCompatibility JavaVersion.VERSION_17
              targetCompatibility JavaVersion.VERSION_17
            }

            kotlinOptions {
              jvmTarget = "17"
            }
          }

          dependencies {
            implementation "androidx.core:core-ktx:1.12.0"
          }
          EOF

          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.example.bestapp">
            <application android:label="Bestapp" />
          </manifest>
          EOF

      # ============================================================
      # t05 — AUTHORITATIVE GRADLE WRAPPER
      # ============================================================
      - name: Generate Gradle Wrapper
        shell: bash
        run: |
          set -e
          mkdir -p .ci-bootstrap

          echo 'repositories { mavenCentral() }' \
            > .ci-bootstrap/build.gradle

          echo 'rootProject.name="bootstrap"' \
            > .ci-bootstrap/settings.gradle

          pushd .ci-bootstrap
          gradle wrapper \
            --gradle-version "${GRADLE_VERSION}" \
            --distribution-type bin
          popd

          mv .ci-bootstrap/gradlew ./gradlew
          rm -rf ./gradle
          mv .ci-bootstrap/gradle ./gradle
          chmod +x gradlew
          rm -rf .ci-bootstrap

      # ============================================================
      # t06 — BUILD (DEBUG)
      # ============================================================
      - name: Build APK
        shell: bash
        run: |
          set -e
          ./gradlew assembleDebug \
            --stacktrace

      # ============================================================
      # t07 — UPLOAD ARTIFACT
      # ============================================================
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
