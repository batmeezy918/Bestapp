---
name: Android CI (Zeta · Self-Healing · Cloud APK)

"on":
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      GRADLE_VERSION: "8.5"
      AGP_VERSION: "8.2.2"
      KOTLIN_VERSION: "1.9.22"

    steps:
      # ============================================================
      # t00 — CHECKOUT
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # t01 — JDK 17
      # ============================================================
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ============================================================
      # t02 — ANDROID SDK
      # ============================================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================================
      # t03 — HOST GRADLE (BOOTSTRAP ONLY)
      # ============================================================
      - name: Setup host Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      # ============================================================
      # t04 — SELF-HEAL PROJECT (ROOT CAUSE FIX)
      # ============================================================
      - name: Self-heal Android project
        shell: bash
        run: |
          set -euo pipefail

          # ---------- gradle.properties ----------
          if [ ! -f gradle.properties ]; then
            printf '%s\n' \
              'org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8' \
              'android.useAndroidX=true' \
              'android.enableJetifier=true' \
              > gradle.properties
          fi

          # ---------- local.properties ----------
          if [ ! -f local.properties ]; then
            printf 'sdk.dir=%s\n' "$ANDROID_HOME" > local.properties
          fi

          # ---------- settings.gradle (PLUGIN FIX) ----------
          if [ ! -f settings.gradle ]; then
            cat > settings.gradle <<'EOF'
pluginManagement {
  repositories {
    google()
    mavenCentral()
    gradlePluginPortal()
  }
}
dependencyResolutionManagement {
  repositoriesMode.set(
    RepositoriesMode.FAIL_ON_PROJECT_REPOS
  )
  repositories {
    google()
    mavenCentral()
  }
}
rootProject.name = "Bestapp"
include(":app")
EOF
          fi

          # ---------- root build.gradle ----------
          if [ ! -f build.gradle ]; then
            cat > build.gradle <<EOF
plugins {
  id "com.android.application" version "${AGP_VERSION}" apply false
  id "org.jetbrains.kotlin.android" version "${KOTLIN_VERSION}" apply false
}
EOF
          fi

          # ---------- app module ----------
          mkdir -p app/src/main

          if [ ! -f app/build.gradle ]; then
            cat > app/build.gradle <<'EOF'
plugins {
  id "com.android.application"
  id "org.jetbrains.kotlin.android"
}

android {
  namespace "com.example.bestapp"
  compileSdk 34

  defaultConfig {
    applicationId "com.example.bestapp"
    minSdk 21
    targetSdk 34
    versionCode 1
    versionName "1.0"
  }

  buildTypes {
    debug {
      debuggable true
    }
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }
}
dependencies {
  implementation "androidx.core:core-ktx:1.12.0"
}
EOF
          fi

          # ---------- AndroidManifest ----------
          if [ ! -f app/src/main/AndroidManifest.xml ]; then
            cat > app/src/main/AndroidManifest.xml <<'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.bestapp">
  <application
      android:label="Bestapp"
      android:allowBackup="true" />
</manifest>
EOF
          fi

      # ============================================================
      # t05 — GRADLE WRAPPER (AUTHORITATIVE)
      # ============================================================
      - name: Generate Gradle wrapper
        shell: bash
        run: |
          set -e
          rm -rf .ci-bootstrap
          mkdir .ci-bootstrap

          printf 'rootProject.name="bootstrap"\n' \
            > .ci-bootstrap/settings.gradle
          printf 'repositories { mavenCentral() }\n' \
            > .ci-bootstrap/build.gradle

          pushd .ci-bootstrap
          gradle wrapper \
            --gradle-version "${GRADLE_VERSION}" \
            --distribution-type bin
          popd

          mv .ci-bootstrap/gradlew ./gradlew
          rm -rf ./gradle
          mv .ci-bootstrap/gradle ./gradle
          chmod +x gradlew
          rm -rf .ci-bootstrap

      # ============================================================
      # t06 — BUILD APK
      # ============================================================
      - name: Build debug APK
        shell: bash
        run: |
          set -e
          ./gradlew assembleDebug --no-daemon --stacktrace
          ls -l app/build/outputs/apk/debug

      # ============================================================
      # t07 — ARTIFACT UPLOAD
      # ============================================================
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
