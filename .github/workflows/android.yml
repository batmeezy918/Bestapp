---
name: Android CI (Fixed · Deterministic · Cloud APK)

"on":
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GRADLE_VERSION: "8.5"
      AGP_VERSION: "8.2.2"
      KOTLIN_VERSION: "1.9.22"

    steps:
      # ============================================================
      # CHECKOUT
      # ============================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # JDK
      # ============================================================
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ============================================================
      # ANDROID SDK
      # ============================================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================================
      # HOST GRADLE (BOOTSTRAP)
      # ============================================================
      - name: Setup host Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      # ============================================================
      # PROJECT STRUCTURE (PLUGIN FIX)
      # ============================================================
      - name: Create project invariants
        shell: bash
        run: |
          set -e

          # gradle.properties
          printf '%s\n' \
            'org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8' \
            'android.useAndroidX=true' \
            'android.enableJetifier=true' \
            > gradle.properties

          # local.properties
          printf 'sdk.dir=%s\n' "$ANDROID_HOME" > local.properties

          # settings.gradle (CRITICAL)
          cat > settings.gradle <<'EOF'
pluginManagement {
  repositories {
    google()
    mavenCentral()
    gradlePluginPortal()
  }
}
dependencyResolutionManagement {
  repositoriesMode.set(
    RepositoriesMode.FAIL_ON_PROJECT_REPOS
  )
  repositories {
    google()
    mavenCentral()
  }
}
rootProject.name = "Bestapp"
include(":app")
EOF

          # root build.gradle
          cat > build.gradle <<EOF
plugins {
  id "com.android.application" version "${AGP_VERSION}" apply false
  id "org.jetbrains.kotlin.android" version "${KOTLIN_VERSION}" apply false
}
EOF

          # app module
          mkdir -p app/src/main

          cat > app/build.gradle <<'EOF'
plugins {
  id "com.android.application"
  id "org.jetbrains.kotlin.android"
}

android {
  namespace "com.example.bestapp"
  compileSdk 34

  defaultConfig {
    applicationId "com.example.bestapp"
    minSdk 21
    targetSdk 34
    versionCode 1
    versionName "1.0"
  }

  buildTypes {
    debug {
      debuggable true
    }
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }
}

dependencies {
  implementation "androidx.core:core-ktx:1.12.0"
}
EOF

          # AndroidManifest
          cat > app/src/main/AndroidManifest.xml <<'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.bestapp">
  <application
      android:label="Bestapp"
      android:allowBackup="true" />
</manifest>
EOF

      # ============================================================
      # GRADLE WRAPPER
      # ============================================================
      - name: Generate Gradle wrapper
        shell: bash
        run: |
          set -e
          rm -rf .ci-bootstrap
          mkdir .ci-bootstrap

          echo 'rootProject.name="bootstrap"' > .ci-bootstrap/settings.gradle
          echo 'repositories { mavenCentral() }' > .ci-bootstrap/build.gradle

          pushd .ci-bootstrap
          gradle wrapper \
            --gradle-version "${GRADLE_VERSION}" \
            --distribution-type bin
          popd

          mv .ci-bootstrap/gradlew ./gradlew
          rm -rf ./gradle
          mv .ci-bootstrap/gradle ./gradle
          chmod +x gradlew
          rm -rf .ci-bootstrap

      # ============================================================
      # BUILD
      # ============================================================
      - name: Build APK
        shell: bash
        run: |
          set -e
          ./gradlew assembleDebug --no-daemon --stacktrace

      # ============================================================
      # ARTIFACT
      # ============================================================
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
