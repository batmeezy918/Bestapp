---
name: Android CI (Cloud-Only · Self-Healing · Verified)

"on":
  workflow_dispatch: {}
  push:
    branches:
      - main

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      GRADLE_VERSION: "8.5"
      AGP_VERSION: "8.2.2"
      KOTLIN_VERSION: "1.9.22"

    steps:
      # ============================================================
      # CHECKOUT
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # JDK 17
      # ============================================================
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ============================================================
      # ANDROID SDK
      # ============================================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================================
      # HOST GRADLE (BOOTSTRAP ONLY)
      # ============================================================
      - name: Setup host Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      # ============================================================
      # SELF-HEAL PROJECT FILES (SAFE, YAML-CLEAN)
      # ============================================================
      - name: Self heal Android project
        shell: bash
        run: |
          set -euo pipefail

          printf '%s\n' \
            'org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8' \
            'android.useAndroidX=true' \
            'android.enableJetifier=true' \
            > gradle.properties

          printf '%s\n' \
            "sdk.dir=${ANDROID_HOME}" \
            > local.properties

          printf '%s\n' \
            'pluginManagement {' \
            '  repositories {' \
            '    google()' \
            '    mavenCentral()' \
            '    gradlePluginPortal()' \
            '  }' \
            '}' \
            'dependencyResolutionManagement {' \
            '  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)' \
            '  repositories {' \
            '    google()' \
            '    mavenCentral()' \
            '  }' \
            '}' \
            'rootProject.name = "Bestapp"' \
            'include(":app")' \
            > settings.gradle

          printf '%s\n' \
            'plugins {' \
            "  id \"com.android.application\" version \"${AGP_VERSION}\" apply false" \
            "  id \"org.jetbrains.kotlin.android\" version \"${KOTLIN_VERSION}\" apply false" \
            '}' \
            > build.gradle

          mkdir -p app/src/main

          printf '%s\n' \
            'plugins {' \
            '  id "com.android.application"' \
            '  id "org.jetbrains.kotlin.android"' \
            '}' \
            '' \
            'android {' \
            '  namespace "com.example.bestapp"' \
            '  compileSdk 34' \
            '' \
            '  defaultConfig {' \
            '    applicationId "com.example.bestapp"' \
            '    minSdk 21' \
            '    targetSdk 34' \
            '    versionCode 1' \
            '    versionName "1.0"' \
            '  }' \
            '' \
            '  buildTypes {' \
            '    release {' \
            '      minifyEnabled false' \
            '    }' \
            '  }' \
            '' \
            '  compileOptions {' \
            '    sourceCompatibility JavaVersion.VERSION_17' \
            '    targetCompatibility JavaVersion.VERSION_17' \
            '  }' \
            '}' \
            '' \
            'dependencies {' \
            '  implementation "androidx.core:core-ktx:1.12.0"' \
            '}' \
            > app/build.gradle

          printf '%s\n' \
            '<manifest xmlns:android="http://schemas.android.com/apk/res/android"' \
            '    package="com.example.bestapp">' \
            '  <application android:label="Bestapp" />' \
            '</manifest>' \
            > app/src/main/AndroidManifest.xml

      # ============================================================
      # GENERATE AUTHORITATIVE GRADLE WRAPPER
      # ============================================================
      - name: Generate Gradle wrapper
        shell: bash
        run: |
          set -e
          rm -rf .ci-bootstrap
          mkdir .ci-bootstrap

          printf '%s\n' 'rootProject.name="bootstrap"' > .ci-bootstrap/settings.gradle
          printf '%s\n' 'repositories { mavenCentral() }' > .ci-bootstrap/build.gradle

          cd .ci-bootstrap
          gradle wrapper --gradle-version "${GRADLE_VERSION}" --distribution-type bin
          cd ..

          mv .ci-bootstrap/gradlew ./gradlew
          rm -rf gradle
          mv .ci-bootstrap/gradle ./gradle
          chmod +x gradlew
          rm -rf .ci-bootstrap

      # ============================================================
      # BUILD APK
      # ============================================================
      - name: Build Debug APK
        shell: bash
        run: |
          set -e
          bash ./gradlew --version
          bash ./gradlew assembleDebug --stacktrace

      # ============================================================
      # UPLOAD ARTIFACT
      # ============================================================
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
